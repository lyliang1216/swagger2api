import e from"chalk";import{render as t}from"eta";import r from"fs";import{mkdirp as s}from"mkdirp";import a,{sep as i,join as o}from"path";import n from"pinyin";import p from"axios";import l from"node:url";import c from"typescript";const m={integer:"number",number:"number",long:"number",string:"string",boolean:"boolean",array:"array",object:"object",timestamp:"string",any:"any"},u=e=>"[object Object]"===Object.prototype.toString.call(e),y=(e,t={})=>p.get(e,{params:t}),f=e=>e.replace(/^\S/,(e=>e.toUpperCase())),d=e=>e?n(e,{style:n.STYLE_NORMAL}).map((e=>f(e[0]))).join("").replace(/[^a-zA-Z ]/g,""):"",h=(e=import.meta.url)=>a.dirname(l.fileURLToPath(e)),g=e=>{if(u(e))return!1;return/^((https|http|ftp|rtsp|mms)?:\/\/)[^\s]+/.test(e)},$=e=>e.replace(/[^\w\s]/gi,""),b=e=>{const t=e.split(i).slice(0,-1).join(i),s=e.split(i).slice(-1)[0].split(".")[0],a=r.readFileSync(e,"utf8"),n=c.transpileModule(a,{compilerOptions:{target:9,module:c.ModuleKind.ESNext}});r.writeFileSync(o(t,`./${s}.js`),n.outputText,"utf8")},j=async e=>{const{rawJson:a,outDir:i,templatePath:n={},apiUrlPrefix:p,needJS:l=!1,modular:c=!0,axiosPath:u="../request"}=e,{api:j=o(h(import.meta.url),"./template/apis.eta"),dts:q=o(h(import.meta.url),"./template/dts.eta")}=n,w=g(a)?(await y(a)).data:a,x="baseArrayType",T=[],S=w.definitions,P=e=>{if(!e)return null;const t=(e?.$ref||e?.items?.$ref)?.split("/").pop()||"";if("禁用请求信息"===t)return null;const r=S[t];if(!r)return null;const s=m[e.type]||"",a=e?.items?.type;if("array"===s&&a)return{title:x,schemaType:m[a]};const{title:i,type:o,properties:n,required:p=[]}=r;return{title:i,schemaType:s,type:m[o],properties:n,required:p}},A=(e,t="rootParentInterName")=>{if(!e)return null;let r="I"+d(e.title);if(t===r)return t;const s=/«(.*?)»/,a=(r.match(s)||[])[1];if(!!a){const e="I"+d(a);r=r.replace(s,"")+"On"+e}if(T.find((e=>e.name===r)))return r;const i=e.properties;if(!i)return;const o=e.required||[],n=[];return Object.keys(i).forEach((e=>{const t=i[e];let s=m[t.type];const a=o.includes(e),p=t.description,l=!!p;if(!!(t?.$ref?(s="object",t?.$ref):t?.items?.$ref?(s="array",t?.items?.$ref):t?.$ref||t?.items?.$ref)){let i,o;if("object"===s){const e=P(t);i=A(e,r),o=i}else if("array"===s){const e=P(t);i=A(e,r),o=i+"[]"}n.push({key:e,type:o,required:a,description:p,hasDescription:l})}else"array"===s&&(s=m[t.items?.type||"any"]+"[]"),n.push({key:e,type:s,required:a,description:p,hasDescription:l})})),T.push({name:r,schema:n,required:!0,type:e.type}),r},I=async(e,t,a)=>{await s(e),r.writeFileSync(o(e,t),a)},O=(e=>{const{paths:t}=e,r=[];for(const e in t){const s=t[e];for(const t in s){const a=s[t],{tags:i,summary:o,parameters:n=[],responses:l=[]}=a,c={header:[],body:[]};n.forEach((e=>{const{name:t,in:r,description:s,required:a,type:i,schema:o}=e,n=()=>({name:t,description:s,required:a,type:m[i],schema:P(o)});c[r]?c[r].push(n()):c[r]=[n()]}));const u=l[200],y={description:u.description,schema:P(u.schema)},f=e.slice(p.length);r.push({path:f,method:t.toUpperCase(),summary:o,tags:i,reqInfo:c,resInfo:y})}}return r})(w),R=(e=>{const t=[];return e.forEach((e=>{const{path:r,method:s,summary:a,tags:i,reqInfo:o,resInfo:n}=e,p=i[0]+" - "+a,l=/{(.*?)}/g,c=[],m={name:i[0]||"orphan",prefix:r.split("/")[1]||"orphan"};let u;for(;null!==(u=l.exec(r));)c.push(u);let y="/"+r.split("/").slice(1).join("/");const d=c.map((e=>f(e[1]))).join(""),h=!!d,g=$(y.replaceAll(l,"").split("/").map(f).join("")+(h?"ByCode"+d:"")+s),b="/"+c.map((e=>`$${e[0]}`)).join("/");y=h?y.replace(l,"")+`${b}`:y,y=y.replaceAll(/\/{2,}/g,"/");const j=h?c.map((e=>e[1])):["data"];let q=!1;const w=(()=>{const e=o.body[0]?.schema??null,t=o.formData??null,r=o.query??null;if(r){const e={title:g+"ReqQuery",type:"object",properties:{...r.reduce(((e,t)=>(e[t.name]={type:t.type,description:t.description},e)),{})}};return q=!0,e}if(t){return{title:g+"FromData",type:"object",properties:{}}}return e})(),T=!!w,S=T&&(w.title===x?w.schemaType+"[]":A(w)||null),P=T&&w.schemaType,I=n?.schema||null,O=!!I,R=O&&A(I)||null,k=O&&I.schemaType;t.push({hasQueryParams:q,isUrlEndParam:h,apiName:g,url:y,group:m,params:j,method:s,description:p,hasReqBody:T,reqType:"array"===P?`${S}[]`:S,hasResBody:O,resType:"array"===k?`Required<${R}>[]`:null===R?null:`Required<${R}>`})})),t})(O),k=r.readFileSync(j,"utf-8"),E=r.readFileSync(q,"utf-8"),F=t(E,{interfaces:T});if(c){const e=R.reduce(((e,t)=>{const{group:r}=t,{prefix:s,name:a}=r;return e[s]=e[s]||[],e[s].push({...t,prefix:s,name:a}),e}),{});let r="";for(const s in e)await I(o(i,"./modules/"),`./${s}.ts`,t(k,{apis:e[s],axiosPath:u})),l&&b(o(i,"./modules/",`./${s}.ts`)),r+=`// ${e[s][0].group.name}\n`,r+=`import ${s} from "./modules/${s}";\n`;r+=`export default{\n      ${Object.keys(e).map((e=>`...${e}`))}\n    }`,await I(i,"/apis.ts",r)}else{const e=t(k,{apis:R,axiosPath:u});await I(i,"./apis.ts",e)}await I(i,"./interfaces.d.ts",F),l&&b(o(i,"./apis.ts"))};var q=async t=>{const r=Array.isArray(t);if(console.log(e.yellow("开始生成api...")),r)for(const e of t)await j(e);else await j(t);console.log(e.green("完成工作,enjoy it!"))};export{m as JavaType2JavaScriptType,d as chineseCharacter2pinyin,b as compileTs,q as default,y as fetchData,f as firstUpperCase,h as getCurrentDirName,u as isObject,g as isUrl,$ as removeSpecialCharacter};
