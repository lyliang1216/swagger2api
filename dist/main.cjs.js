"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("chalk"),t=require("eta"),r=require("fs"),n=require("mkdirp"),s=require("path"),a=require("pinyin"),i=require("axios"),o=require("node:url"),p=require("typescript");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=c(e),l=c(r),d=c(s),f=c(a),m=c(i),y=c(o),h=c(p);const j={integer:"number",number:"number",long:"number",string:"string",boolean:"boolean",array:"array",object:"object",timestamp:"string",any:"any"},q=e=>"[object Object]"===Object.prototype.toString.call(e),b=(e,t={})=>m.default.get(e,{params:t}),g=e=>e.replace(/^\S/,(e=>e.toUpperCase())),x=e=>e?f.default(e,{style:f.default.STYLE_NORMAL}).map((e=>g(e[0]))).join("").replace(/[^a-zA-Z ]/g,""):"",$=(e=("undefined"==typeof document?new(require("url").URL)("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("main.cjs.js",document.baseURI).href))=>d.default.dirname(y.default.fileURLToPath(e)),w=e=>{if(q(e))return!1;return/^((https|http|ftp|rtsp|mms)?:\/\/)[^\s]+/.test(e)},S=e=>e.replace(/[^\w\s]/gi,""),R=e=>{const t=e.split(s.sep).slice(0,-1).join(s.sep),r=e.split(s.sep).slice(-1)[0].split(".")[0],n=l.default.readFileSync(e,"utf8"),a=h.default.transpileModule(n,{compilerOptions:{target:9,module:h.default.ModuleKind.ESNext}});l.default.writeFileSync(s.join(t,`./${r}.js`),a.outputText,"utf8")},U=async e=>{const{rawJson:r,outDir:a,templatePath:i={},apiUrlPrefix:o,needJS:p=!1,modular:c=!0,axiosPath:u="../request"}=e,{api:d=s.join($("undefined"==typeof document?new(require("url").URL)("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("main.cjs.js",document.baseURI).href),"./template/apis.eta"),dts:f=s.join($("undefined"==typeof document?new(require("url").URL)("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("main.cjs.js",document.baseURI).href),"./template/dts.eta")}=i,m=w(r)?(await b(r)).data:r,y="baseArrayType",h=[],q=m.definitions,U=e=>{if(!e)return null;const t=(e?.$ref||e?.items?.$ref)?.split("/").pop()||"";if("禁用请求信息"===t)return null;const r=q[t];if(!r)return null;const n=j[e.type]||"",s=e?.items?.type;if("array"===n&&s)return{title:y,schemaType:j[s]};const{title:a,type:i,properties:o,required:p=[]}=r;return{title:a,schemaType:n,type:j[i],properties:o,required:p}},T=(e,t="rootParentInterName")=>{if(!e)return null;let r="I"+x(e.title);if(t===r)return t;const n=/«(.*?)»/,s=(r.match(n)||[])[1];if(!!s){const e="I"+x(s);r=r.replace(n,"")+"On"+e}if(h.find((e=>e.name===r)))return r;const a=e.properties;if(!a)return;const i=e.required||[],o=[];return Object.keys(a).forEach((e=>{const t=a[e];let n=j[t.type];const s=i.includes(e),p=t.description,c=!!p;if(!!(t?.$ref?(n="object",t?.$ref):t?.items?.$ref?(n="array",t?.items?.$ref):t?.$ref||t?.items?.$ref)){let a,i;if("object"===n){const e=U(t);a=T(e,r),i=a}else if("array"===n){const e=U(t);a=T(e,r),i=a+"[]"}o.push({key:e,type:i,required:s,description:p,hasDescription:c})}else"array"===n&&(n=j[t.items?.type||"any"]+"[]"),o.push({key:e,type:n,required:s,description:p,hasDescription:c})})),h.push({name:r,schema:o,required:!0,type:e.type}),r},I=async(e,t,r)=>{await n.mkdirp(e),l.default.writeFileSync(s.join(e,t),r)},P=(e=>{const{paths:t}=e,r=[];for(const e in t){const n=t[e];for(const t in n){const s=n[t],{tags:a,summary:i,parameters:p=[],responses:c=[]}=s,u={header:[],body:[]};p.forEach((e=>{const{name:t,in:r,description:n,required:s,type:a,schema:i}=e,o=()=>({name:t,description:n,required:s,type:j[a],schema:U(i)});u[r]?u[r].push(o()):u[r]=[o()]}));const l=c[200],d={description:l.description,schema:U(l.schema)},f=e.slice(o.length);r.push({path:f,method:t.toUpperCase(),summary:i,tags:a,reqInfo:u,resInfo:d})}}return r})(m),L=(e=>{const t=[];return e.forEach((e=>{const{path:r,method:n,summary:s,tags:a,reqInfo:i,resInfo:o}=e,p=a[0]+" - "+s,c=/{(.*?)}/g,u=[],l={name:a[0]||"orphan",prefix:r.split("/")[1]||"orphan"};let d;for(;null!==(d=c.exec(r));)u.push(d);let f="/"+r.split("/").slice(1).join("/");const m=u.map((e=>g(e[1]))).join(""),h=!!m,j=S(f.replaceAll(c,"").split("/").map(g).join("")+(h?"ByCode"+m:"")+n),q="/"+u.map((e=>`$${e[0]}`)).join("/");f=h?f.replace(c,"")+`${q}`:f,f=f.replaceAll(/\/{2,}/g,"/");const b=h?u.map((e=>e[1])):["data"];let x=!1;const $=(()=>{const e=i.body[0]?.schema??null,t=i.formData??null,r=i.query??null;if(r){const e={title:j+"ReqQuery",type:"object",properties:{...r.reduce(((e,t)=>(e[t.name]={type:t.type,description:t.description},e)),{})}};return x=!0,e}if(t){return{title:j+"FromData",type:"object",properties:{}}}return e})(),w=!!$,R=w&&($.title===y?$.schemaType+"[]":T($)||null),U=w&&$.schemaType,I=o?.schema||null,P=!!I,L=P&&T(I)||null,O=P&&I.schemaType;t.push({hasQueryParams:x,isUrlEndParam:h,apiName:j,url:f,group:l,params:b,method:n,description:p,hasReqBody:w,reqType:"array"===U?`${R}[]`:R,hasResBody:P,resType:"array"===O?`Required<${L}>[]`:null===L?null:`Required<${L}>`})})),t})(P),O=l.default.readFileSync(d,"utf-8"),_=l.default.readFileSync(f,"utf-8"),k=t.render(_,{interfaces:h});if(c){const e=L.reduce(((e,t)=>{const{group:r}=t,{prefix:n,name:s}=r;return e[n]=e[n]||[],e[n].push({...t,prefix:n,name:s}),e}),{});let r="";for(const n in e)await I(s.join(a,"./modules/"),`./${n}.ts`,t.render(O,{apis:e[n],axiosPath:u})),p&&R(s.join(a,"./modules/",`./${n}.ts`)),r+=`// ${e[n][0].group.name}\n`,r+=`import ${n} from "./modules/${n}";\n`;r+=`export default{\n      ${Object.keys(e).map((e=>`...${e}`))}\n    }`,await I(a,"/apis.ts",r)}else{const e=t.render(O,{apis:L,axiosPath:u});await I(a,"./apis.ts",e)}await I(a,"./interfaces.d.ts",k),p&&R(s.join(a,"./apis.ts"))};exports.JavaType2JavaScriptType=j,exports.chineseCharacter2pinyin=x,exports.compileTs=R,exports.default=async e=>{const t=Array.isArray(e);if(console.log(u.default.yellow("开始生成api...")),t)for(const t of e)await U(t);else await U(e);console.log(u.default.green("完成工作,enjoy it!"))},exports.fetchData=b,exports.firstUpperCase=g,exports.getCurrentDirName=$,exports.isObject=q,exports.isUrl=w,exports.removeSpecialCharacter=S;
